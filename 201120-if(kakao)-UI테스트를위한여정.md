# if(kakao) 2020 

## UI 테스트를 위한 여정 - 카카오 권태민님

공통 UI 컴포넌트의 변경을 추적하기 위해 UI 테스트를 적용하면서 경험한 다양한 이슈들

### 갑자기 왜 UI 테스트를 도입했나요?

- 공통 디자인 컴포넌트 특성 상 지속적으로 컴포넡트 추가, 변경이 일어난다.
- UI의 변경 사항을 추적하기 어렵다.
- Storybook을 사용하고 있지만 매번 수동으로 변경 사항을 확인하는 건 매우 번거로운 일.
- 그래서 먼저 스냅샷 테스트를 적용하기로 결정

### 스냅샷 테스트

DOM이 예기치 않게 변경되었을 때 기존과 현재의 코드 스냅샷을 통해 비교해서 차이가 있는지 확인하는 테스트. Jest를 사용해 쉽게 구현 가능.

Storybook의 addon인 Storyshots 사용

react-test-renderer와 함께 사용 > ref 문제 > Enzyme로 렌더러 변경

### MonoRepo 관련 이슈

상위 컴포넌트의 asset을 사용하고 있는데, jest가 상위 컴포넌트를 인식하지 못함

모노레포의 장점 포기하지 않기 위해 rootDir를 최상위 디렉토리로 변경

### 기타 이슈

- 랜덤 데이터는 스냅샷에서 안되기 때문에 데이터 고정
- 스냅샷 테스트는 DOM의 변경사항만 추적할 수 있다 > CSS 추적 불가능

### 시각적 회귀 테스트

컴포넌트가 렌더링된 상태의 이미지를 캡처해 과거와 현재를 비교. 이미지를 비교하므로 UI 변경에 민감

soryshots-puppeteer라는 애드온이 있어 시각적 회귀 테스트 구축

- 컴포넌트에 GIF 있으면 완전한 비교 안됨
- Datepicker, Select같은 컴포넌트는 열려있는 상태로 테스트되어야함
- CSS로 Active하는 경우 별도의 시뮬레이션 필요

### 후속 작업

- 시각적 회귀 테스트는 Headless 브라우저를 통해 진행되므로 속도가 느리다.
- 로컬에서 진행된 시각적 회귀 테스트는 신뢰할 수 없다.
- 따라서 Jenkins에서 테스트하도록 연동

## Jenkins 연동

시나리오 초안

1. 새로운 PR 올라오면 프리뷰 Storybook 생성
2. 스냅샷 테스트, 시각적 회귀 테스트 job trigger
   - 테스트 성공시 해당 PR에 성공 댓글
   - 테스트 실패시 실패한 이미지들을 CDN에 업로드 후 URL과 함께 실패 댓글

- Docker 컨테이너 내에서 Headless 브라우저 실행 문제
- 한글 폰트 깨짐 문제 > 설치

트리거의 주체가 PR이 되게 하고싶음

1. 공통으로 사용할 Docker 베이스 이미지 빌드
2. 프리뷰 레이블 추가, 레이블에 매칭되는 job이 이를 감지해 프리뷰를 빌드, 배포
3. 배포가 완료되면 각 테스트들에 대한 레이블 추가해 테스트 수행
4. 각 테스트 완료시 테스트 결과를 댓글로 남김

![image-20201120133600783](/Users/subin/Library/Application Support/typora-user-images/image-20201120133600783.png)

## 테스트 도입시 고려해야할 것

- 테스트에 대한 가이드와 자동화된 프로세스 필요
  - 의도적인 UI 변경은 어떻게 대응할 것인지?
- 개발 중인 서비스가 세세한 컴포넌트, 페이지 단위로 분리가 가능한 구조인지?
- 정말로 현재 상황에서 이 테스트들이 필요한가?
  - 서비스의 UI에 문제가 생기면 다른 서비스에 즉각적인 영향을 주는가?
  - 구축, 운영에 들이는 노력보다 얻을 수 있는 이점이 더 큰가?

